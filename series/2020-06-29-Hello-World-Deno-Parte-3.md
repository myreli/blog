---
id: /2020/06/29/Hello-World-Deno-Parte-3

title: Hello World, Deno! - Parte 3 - Visitando APIs Web
summary: O poder do JavaScript do browser no Back-End de verdade - APIs da Web em Deno ðŸ¦•

date: 2020-06-29 09:23:21 Z

cover: "/img/posts/2020-05-16-Hello-World-Deno/cover.jpg"

tags: [tutorial, deno]
---

Dale! Como vai?

No artigo anterior falamos sobre vÃ¡rias coisas em busca de um Ãºnico objetivo: preparar o terreno para o nosso aplicativo e entender um pouco da experiÃªncia de usuÃ¡rio fornecida por Deno. Caso nÃ£o faÃ§a ideia do que estou falando, pode comeÃ§ar a ler [aqui](https://myreli.dev/blog/2020/05/16/Hello-World-Deno.html).

> Demorei, mas voltei. :)
>
> PeÃ§o desculpas pela demora eterna hehe. Caso tenha curiosidade de saber o porquÃª de tanta demora, estou considerando abrir meu coraÃ§Ã£o sobre aqui, mas enquanto isso [acesse todos esses links](https://vidasnegrasimportam.carrd.co/). Caso nÃ£o tome coragem para publicar quero dizer aos meus amigos, conhecidos e desconhecidos negros: Eu sinto muito. Vidas negras importam.
>
> AlÃ©m disso, nesse Ãºltimo final de semana saiu a terceira e Ãºltima temporada de Dark.

Hoje, vamos evoluir nossa aplicaÃ§Ã£o comunicando de verdade com o ChapÃ©u Seletor.

> Essa Ã© a terceira parte de uma sÃ©rie de artigos sobre Deno:

1. [Hello World, Deno! - Parte I](https://myreli.dev/blog/2020/05/16/Hello-World-Deno.html) _disponÃ­vel_
2. [Hello World, Deno! - Iniciando uma aplicaÃ§Ã£o - Parte II](https://myreli.dev/blog/2020/05/18/Hello-World-Deno-Parte-2.html) _disponÃ­vel_
3. [Hello World, Deno! - Visitando APIs Web - Parte III](#) **vocÃª estÃ¡ aqui**
4. [Hello World, Deno! - Visitando APIS Nativas - Parte IV](#) _em breve_
5. [Hello World, Deno! - ConsideraÃ§Ãµes finais Parte V](#) _em breve_

Lembra a introduÃ§Ã£o sobre Deno em que fizemos uma chamada no terminal para o chapÃ©u seletor e ele dizia qual era a casa?

Pois entÃ£o, vamos trazer aquela mÃ¡gica para dentro do nosso cÃ³digo.

### ComunicaÃ§Ã£o: acessando e consumindo APIs com Deno

Precisamos comunicar com o ChapÃ©u Seletor e isso ocorre atravÃ©s de uma _interface_, como mencionado anteriormente. Essa interface, conhecida como API, Ã© uma interface HTTP disponÃ­vel atravÃ©s da URL: [https://www.potterapi.com/v1/sortingHat/](https://www.potterapi.com/v1/sortingHat/).

O que precisamos fazer Ã©: acessar essa URL atravÃ©s do nosso programa para relacionar o sorteio ao aluno sorteado.

Anteriormente, atravÃ©s de um terminal, a comunicaÃ§Ã£o foi feita dessa forma:

```shell
deno run https://deno.land/std/examples/curl.ts https://www.potterapi.com/v1/sortingHat/ --allow-net=www.potterapi.com
```

Desmembrando cada parte desse comando, temos o seguinte:

| comando                                    | descriÃ§Ã£o                                                                                             |
| ------------------------------------------ | ----------------------------------------------------------------------------------------------------- |
| `deno run`                                 | utilizamos o global Deno para invocar a sua funÃ§Ã£o `run`, que serve para executar um script Deno      |
| `https://deno.land/std/examples/curl.ts`   | definimos que o programa a ser executado Ã© o `curl.ts`, disponÃ­vel em https://deno.land/std/examples/ |
| `https://www.potterapi.com/v1/sortingHat/` | passamos como parÃ¢metro para este programa a API de Harry Potter no endpoint do ChapÃ©u Seletor        |
| `--allow-net=www.potterapi.com`            | permitimos a comunicaÃ§Ã£o com a internet no endpoint especificado                                      |

Ou seja, utilizamos um programa chamado `curl` do Deno para acessar uma pÃ¡gina e exibir o resultado dela. Esse programa visita a pÃ¡gina de Harry Potter, processa o conteÃºdo dela e retorna para quem chamou, mas podemos fazer isso de forma direta.

PoderÃ­amos importar este programa dentro do nosso e utilizar? Sim! Mas, neste caso, Ã© mais rÃ¡pido (e fÃ¡cil) chamarmos atravÃ©s de uma Web API em nossa aplicaÃ§Ã£o do que atravÃ©s de um outro programa e recuperar o conteÃºdo direto da fonte.

Em sÃ­ntese: nossa CLI precisa acessar a internet no endereÃ§o da API, a API falarÃ¡ com o chapÃ©u seletor e retornarÃ¡ para a casa sorteada.

### JavaScript, Back-End, Deno... Web APIs?

Deno tem o compromisso de nÃ£o reinventar a roda (quando a roda funciona bem :stuck_out_tongue_winking_eye:) e por isso as APIs da Web que jÃ¡ sÃ£o sÃ³lidas e atendem todas as necessidades sÃ£o trazidas do Browser atravÃ©s de Deno.

Um exemplo dessas APIs Ã© o [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API) que em sua forma mais simples funciona assim:

```typescript
// collect raw response from URL
const rawResponse = await fetch("URL");
// proccess response as structured data
const body = await rawResponse.text(); // OR .json()
```

Primeiro, existe a funÃ§Ã£o `fetch()` que retorna uma [promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise) contendo mÃ©todos utilitÃ¡rios e a resposta pura da pÃ¡gina. Depois, utilizamos um desses mÃ©todos para processar a resposta no formato que desejamos, por exemplo, texto ou JSON.

Agora vamos testar nossa prÃ³pria implementaÃ§Ã£o para chamar a API de Harry Potter e mostrar a casa sorteada.

Para isso, utilizamos essa API e basta substituir o texto `'URL'` pela URL que queremos chamar, neste caso, a do ChapÃ©u Seletor. Em um arquivo `.ts` qualquer, vai ser algo, mais ou menos, assim:

![](https://i.vgy.me/3zlGMm.png)

Para executar, lembre-se de permitir corretamente o acesso a rede.

Existem vÃ¡Ã¡rias outras APIs da Web implementadas, inclusive **[addEventListener](https://doc.deno.land/https/github.com/denoland/deno/releases/latest/download/lib.deno.d.ts#addEventListener)!!!** Todas as funÃ§Ãµes estÃ£o disponÃ­veis na [documentaÃ§Ã£o oficial](https://doc.deno.land/https/github.com/denoland/deno/releases/latest/download/lib.deno.d.ts#fetch).

### But first...

~~[Let me take a selfie](https://www.youtube.com/watch?v=SuyG-lIkNow)~~ Vamos estruturar a aplicaÃ§Ã£o =D

AtÃ© o momento temos as peÃ§as do nosso projeto de forma separadas entÃ£o precisamos fazer um trabalho de _refatoraÃ§Ã£o_ para preparar todas as etapas. E, entÃ£o, ir preenchendo cada parte e formar o resultado final.

> No geral, eu gosto da prÃ¡tica de ir planejando a estrutura do cÃ³digo de forma macro antes de ir resolvendo cada problema de forma individual. Otimiza a soluÃ§Ã£o de problemas grandes, favorece o sistema de recompensas do cÃ©rebro e encaixa muito bem com TDD.

Do Ãºltimo artigo discutimos sobre qual seria a estrutura, mas nÃ£o executamos ela de fato. E encerramos assim:

![](https://i.vgy.me/PolDPR.png)

Agora vamos fazer aplicar essa estrutura. Apesar de ser uma simples CLI Ã© importante manter as coisas minimamente organizadas, principalmente para no artigo final quando dermos uma olhadinha na suite nativa de testes. :)

A primeira coisa que eu fiz foi mover a lÃ³gica anterior para uma funÃ§Ã£o chamada `identifyStudent` e chamar essa funÃ§Ã£o dentro do meu arquivo.

![](https://i.vgy.me/VhVN41.png)

Tudo funciona exatamente como antes, mas agora temos um cÃ³digo mais legÃ­vel.

> **#code-tip:** execute `deno info mod.ts` para inspecionar todas as dependÃªncias do seu projeto e tenha de forma detalhada a origem de tudo:
>
> ```shell
> âžœ  hello-deno-harry-potter (hello-web-apis) âœ— deno info mod.ts
> local: /home/myreli/code/deno/hello-deno-harry-potter/mod.ts
> type: TypeScript
> compiled: /home/myreli/.cache/deno/gen/file/home/myreli/code/deno/hello-deno-harry-potter/mod.ts.js
> map: /home/myreli/.cache/deno/gen/file/home/myreli/code/deno/hello-deno-harry-potter/mod.ts.js.map
> deps:
> file:///home/myreli/code/deno/hello-deno-harry-potter/mod.ts
>   â”œâ”€â”€ file:///home/myreli/code/deno/hello-deno-harry-potter/student.ts
>   â”œâ”€â”€ file:///home/myreli/code/deno/hello-deno-harry-potter/log.service.ts
>   â””â”€â”€ file:///home/myreli/code/deno/hello-deno-harry-potter/sorting_hat.service.ts
> ```

Seguindo o mesmo procedimento para os outros dois que precisamos, vamos terminar com algo assim:

![](https://i.vgy.me/74mpmF.png)

Algumas coisas importantes:

- preparei toda a estrutura do que serÃ¡ nosso programa final, de forma que agora precisamos apenas preencher os espaÃ§os
- diferente do Node, Deno _sempre_ encerra o processo caso algum erro nÃ£o tratado ocorra. entÃ£o Ã© importante sempre lembrar de lidar com eles. (o `try/catch` genÃ©rico ao redor de tudo Ã© a forma como vamos lidar agora)
- nÃ£o se preocupe em fazer tudo como eu fiz, as peÃ§as podem ser reunidas de diversas formas diferentes e essa nÃ£o Ã© a melhor :)

### Implementando a comunicaÃ§Ã£o

Vamos implementar na funÃ§Ã£o `identifyHouse` a chamada a API externa do Harry Potter? yo o/

Primeiro Ã© necessÃ¡rio coletar a resposta da API:

```typescript
const response = await fetch("https://www.potterapi.com/v1/sortingHat/");
```

Depois transformar essa resposta em texto e salvar a casa:

```typescript
const house = await response.text();
```

E, finalmente, retornar a casa para que o processamento possa seguir em frente:

```typescript
return house;
```

Agora, retornando para o nosso terminal, vamos ver como ficou tudo no final. Lembre-se de utilizar a flag de permissÃ£o de internet dessa vez, jÃ¡ que estamos acessando a internet:

![](https://i.vgy.me/iMteDR.png)

> **#code-tip:** a qualquer momento vocÃª pode executar `deno fmt <arquivo>` para formatar seu arquivo com as indentaÃ§Ãµes, espaÃ§amentos e organizaÃ§Ã£o corretinhas :wink:

### PrÃ³ximos passos

E Ã© isso! Um artigo inteiro para trÃªs linhas de cÃ³digo :stuck_out_tongue_closed_eyes: mas espero que tenha valido a pena! Em comparaÃ§Ã£o, caso vocÃª nÃ£o conheÃ§a node.js, uma requisiÃ§Ã£o de forma nativa seria feita dessa forma:

```javascript
const https = require("https");

https
  .get("https://www.potterapi.com/v1/sortingHat/", (response) => {
    let data = "";

    response.on("data", (chunk) => {
      data += chunk;
    });

    response.on("end", () => {
      console.info(data);
    });
  })
  .on("error", (error) => {
    console.error(
      `Um erro impediu que a seleÃ§Ã£o fosse concluÃ­da ${error.message}`
    );
  });
```

Bleh! Por isso que a request ficou tÃ£o famosa que as pessoas comeÃ§aram a pensar que ela era "nativa". E aÃ­ todo mundo se surpreendeu quando o criador decidiu [encerrar o suporte](https://github.com/request/request/issues/3142). (Com razÃµes com as quais concordo plenamente, por sinal)

No prÃ³ximo artigo vamos implementar a Ãºltima parte do nosso sistema para deixar o ChapÃ©u Seletor, a OMS e os bruxos felizes: escrita no arquivo de log. ~~Mas, para deixar a Myreli feliz vamos ter um Ãºltimo artigo de consideraÃ§Ãµes finais para outras curiosidades legais e Ãºteis sobre Deno.~~

Todo o cÃ³digo atÃ© agora estÃ¡ disponÃ­vel no [Github](https://github.com/myreli/hello-deno-harry-potter/tree/hello-web-apis).

Muito obrigada por ter lido atÃ© aqui! Espero que esteja sendo uma leitura e experiÃªncia prazerosa.

AtÃ© breve.
